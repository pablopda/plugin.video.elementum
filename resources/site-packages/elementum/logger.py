# Borrowed and modified from xbmcswift
import logging

from kodi_six import xbmc

from elementum.addon import ADDON, ADDON_ID

class XBMCHandler(logging.StreamHandler):
    xbmc_levels = {
        'DEBUG': 0,
        'INFO': 2,
        'WARNING': 3,
        'ERROR': 4,
        'CRITICAL': 5,
    }

    def emit(self, record):
        xbmc_level = self.xbmc_levels.get(record.levelname)
        xbmc.log(self.format(record), xbmc_level)


loggers = {}

def _get_logger(name):
    if loggers.get(name):
        return loggers.get(name)

    logger = logging.getLogger(ADDON_ID)
    log_level_str = ADDON.getSetting("log_level")
    try:
        log_level = int(log_level_str)
    except (ValueError, TypeError):
        log_level = 3  # Default to DEBUG if conversion fails

    if log_level == 0:
        logger.setLevel(logging.CRITICAL)
    elif log_level == 1:
        logger.setLevel(logging.ERROR)
    elif log_level == 2:
        logger.setLevel(logging.INFO)
    else:
        logger.setLevel(logging.DEBUG)

    handler = XBMCHandler()
    handler.setFormatter(logging.Formatter('[%(name)s] %(message)s'))
    logger.addHandler(handler)
    loggers[name] = logger
    return logger


log = _get_logger(__name__)
