# elementum

## Purpose

Core plugin code containing all main functionality for the Elementum Kodi addon.

## Modules

### Entry Points

- **navigation.py** - Main UI navigation and menu handling (500+ lines)
  - Routes plugin URLs
  - Manages media discovery
  - Handles search
  - Integrates with TMDB/Trakt

- **service.py** - Background service management
  - Starts RPC server
  - Manages ElementumMonitor
  - Spawns daemon thread

### Daemon Management

- **daemon.py** - Elementumd binary process manager (500+ lines)
  - Cross-platform binary detection
  - Automatic download from GitHub
  - Process monitoring and restart
  - Subprocess management

- **config.py** - Configuration and daemon settings
  - `ELEMENTUMD_HOST` - Daemon HTTP address
  - `JSONRPC_EXT_PORT` - RPC port
  - `ONLY_CLIENT` - Client-only mode

### Communication

- **rpc.py** - JSON-RPC server for Kodi communication (500+ lines)
  - Runs as separate thread
  - Handles method calls from daemon
  - Manages dialogs and playback

- **monitor.py** - Kodi event monitoring
  - Settings changes
  - Abort requests
  - Property tracking

### Provider Integration

- **provider.py** - Provider addon interface
  - Resolution constants (480p-4K)
  - RIP quality types
  - Codec definitions
  - Provider discovery

### UI Components

- **dialog.py** - Base dialog functionality
- **dialog_select.py** - Stream/torrent selection dialog
- **dialog_insert.py** - Magnet/torrent insertion dialog
- **overlay.py** - On-screen status overlay

### Utilities

- **addon.py** - Addon metadata (ID, name, version, paths)
- **util.py** - General utilities (250+ lines)
  - Path translation
  - Notifications
  - Localization
  - System information

- **kodiutils.py** - Kodi-specific utilities
  - JSON-RPC calls
  - Signal handling
  - Resolution constants

- **logger.py** - Logging with XBMC integration
- **osarch.py** - Platform/OS detection (200+ lines)
- **unicode.py** - Unicode handling
- **taller.py** - HTTP download with progress

## Key Classes

### navigation.py
- `RedirectException` - Menu redirect
- `PlayerException` - Player errors
- `InfoLabels` - Media metadata dict

### service.py
- Threaded service startup
- Event loop management

### daemon.py
- `elementumd_thread()` - Main daemon loop
- `start_daemon()` - Launch binary
- `download_daemon()` - Fetch from GitHub

### rpc.py
- `ElementumRPCServer(BaseHandler)` - RPC methods
  - `Ping()`, `Refresh()`, `Reset()`
  - Video/playback control

### dialog_select.py
- `DialogSelect(WindowXMLDialog)` - Stream chooser

### overlay.py
- `OverlayText` - Status display

### logger.py
- `XBMCHandler(StreamHandler)` - Log integration

## Data Flow

```
User Action → navigation.py → daemon.py (RPC) → Elementumd
                                    ↓
                              provider.py
                                    ↓
                              dialog_select.py → User Choice
                                    ↓
                              Playback + overlay.py
```

## Notes

- Most modules are 200-500+ lines
- Heavy use of Kodi APIs (xbmc, xbmcgui, xbmcaddon)
- JSON-RPC for daemon communication
- Threading for background operations
