from kodi_six import xbmcaddon
from kodi_six import xbmc

ONLY_CLIENT = False
JSONRPC_EXT_PORT = 65221
ELEMENTUMD_HOST = "http://127.0.0.1:65220"

# Default values for fallback
DEFAULT_HOST = "127.0.0.1"
DEFAULT_REMOTE_PORT = 65220
DEFAULT_LOCAL_PORT = 65221

def _parse_port(value, default, setting_name):
    """
    Parse and validate a port number from a setting value.

    Args:
        value: The setting value to parse
        default: Default port to return on error
        setting_name: Name of the setting for logging

    Returns:
        Valid port number (1-65535) or default on error
    """
    if not value or not value.strip():
        xbmc.log("Elementum: Empty value for setting '{}', using default: {}".format(
            setting_name, default), xbmc.LOGWARNING)
        return default

    try:
        port = int(value.strip())
        if port < 1 or port > 65535:
            xbmc.log("Elementum: Invalid port range for '{}': {} (must be 1-65535), using default: {}".format(
                setting_name, port, default), xbmc.LOGWARNING)
            return default
        return port
    except (ValueError, TypeError) as e:
        xbmc.log("Elementum: Failed to parse port for '{}': '{}' - {}, using default: {}".format(
            setting_name, value, str(e), default), xbmc.LOGWARNING)
        return default

def _validate_host(value, default, setting_name):
    """
    Validate a host setting value.

    Args:
        value: The setting value to validate
        default: Default host to return on error
        setting_name: Name of the setting for logging

    Returns:
        Valid host string or default on error
    """
    if not value or not value.strip():
        xbmc.log("Elementum: Empty value for setting '{}', using default: {}".format(
            setting_name, default), xbmc.LOGWARNING)
        return default
    return value.strip()

def init():
    global ELEMENTUMD_HOST
    global JSONRPC_EXT_PORT
    global ONLY_CLIENT

    try:
        ADDON = xbmcaddon.Addon("plugin.video.elementum")
    except Exception as e:
        xbmc.log("Elementum: Failed to get addon settings: {}, using defaults".format(str(e)), xbmc.LOGERROR)
        return

    try:
        # Parse and validate remote host
        remote_host = _validate_host(
            ADDON.getSetting("remote_host"),
            DEFAULT_HOST,
            "remote_host"
        )

        # Parse and validate remote port
        remote_port = _parse_port(
            ADDON.getSetting("remote_port"),
            DEFAULT_REMOTE_PORT,
            "remote_port"
        )

        # Construct the host URL
        ELEMENTUMD_HOST = "http://{}:{}".format(remote_host, remote_port)

        # Parse and validate local port
        JSONRPC_EXT_PORT = _parse_port(
            ADDON.getSetting("local_port"),
            DEFAULT_LOCAL_PORT,
            "local_port"
        )

        # Parse only client setting
        ONLY_CLIENT = ADDON.getSetting("local_only_client") == u"true"

    except Exception as e:
        xbmc.log("Elementum: Unexpected error reading settings: {}, using defaults".format(str(e)), xbmc.LOGERROR)


init()
